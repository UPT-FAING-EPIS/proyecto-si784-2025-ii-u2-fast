name: Build and Release APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    defaults:
      run:
        working-directory: upt_tutoria_app
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Disable Flutter analytics
      run: flutter config --no-analytics

    - name: Accept Android licenses
      run: yes | flutter doctor --android-licenses || true

    - name: Clean Flutter
      run: flutter clean

    - name: Get dependencies
      run: flutter pub get

    - name: Update dependencies
      run: flutter pub upgrade

    - name: Setup custom app icon (if upt.ico exists)
      run: |
        if [ -f "assets/upt.ico" ]; then
          echo "Setting up custom app icon..."
          
          # Install ImageMagick for icon conversion
          sudo apt-get update
          sudo apt-get install -y imagemagick
          
          # Create icon directories if they don't exist
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          # Convert .ico to different PNG sizes for Android
          convert assets/upt.ico -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert assets/upt.ico -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert assets/upt.ico -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert assets/upt.ico -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert assets/upt.ico -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          echo "Custom icon configured successfully!"
        else
          echo "No custom icon found at assets/upt.ico, using default icon"
        fi

    - name: Run tests (optional)
      run: flutter test || echo "No tests found, continuing..."

    # 1. Lee la versi칩n base de pubspec.yaml (ej: 1.0.0)
    # 2. Busca en GitHub la tag m치s reciente que empiece con "v1.0." (ej: v1.0.0, v1.0.1, etc.)
    # 3. Si la versi칩n del pubspec es M츼S NUEVA que la 칰ltima tag (ej: subiste pubspec a 1.1.0), usa la del pubspec.
    # 4. Si la 칰ltima tag es IGUAL o MAYOR (ej: v1.0.2), incrementa el 칰ltimo n칰mero (ej: v1.0.3)
    - name: Determine Next Version
      id: version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 1. Obtener la versi칩n base de pubspec.yaml (ej: 1.0.0)
        BASE_VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1 | tr -d '\r')
        echo "Pubspec base version: $BASE_VERSION"
        
        # 2. Obtener el Major.Minor (ej: 1.0)
        MAJOR_MINOR=$(echo "$BASE_VERSION" | cut -d '.' -f 1,2)
        
        # 3. Buscar la 칰ltima tag existente para este Major.Minor (ej: v1.0.0, v1.0.1...)
        #    Usamos 'gh tag list' y ordenamos por versi칩n de forma descendente
        LATEST_TAG=$(gh tag list "v${MAJOR_MINOR}.*" --sort="-version:refname" | head -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          # No existe ninguna tag para "v1.0.*". Usamos la versi칩n base del pubspec.
          FINAL_VERSION=$BASE_VERSION
          echo "No existing tags found for v${MAJOR_MINOR}.*. Using base version: $FINAL_VERSION"
        else
          # S칤 existen tags. Comparamos la versi칩n base con la 칰ltima tag.
          LATEST_TAG_VERSION=$(echo "$LATEST_TAG" | cut -c 2-) # Quita la 'v' (ej: 1.0.1)
          
          # Comparamos cu치l es mayor: la del pubspec o la 칰ltima tag
          # (usamos 'sort -V' que entiende de n칰meros de versi칩n)
          HIGHEST_VERSION=$( (echo "$BASE_VERSION"; echo "$LATEST_TAG_VERSION") | sort -V | tail -n 1)
          
          if [ "$HIGHEST_VERSION" == "$LATEST_TAG_VERSION" ]; then
            # La 칰ltima tag (ej: 1.0.2) es >= que la del pubspec (ej: 1.0.0)
            # Debemos incrementar la 칰ltima tag.
            LATEST_PATCH=$(echo "$LATEST_TAG_VERSION" | cut -d '.' -f 3)
            NEXT_PATCH=$((LATEST_PATCH + 1))
            FINAL_VERSION="${MAJOR_MINOR}.${NEXT_PATCH}"
            echo "Latest tag ($LATEST_TAG) is >= pubspec ($BASE_VERSION). Incrementing tag to: $FINAL_VERSION"
          else
            # La versi칩n del pubspec (ej: 1.1.0) es m치s nueva que la 칰ltima tag (ej: v1.0.2)
            # Usamos la versi칩n del pubspec.
            FINAL_VERSION=$BASE_VERSION
            echo "Pubspec version ($BASE_VERSION) is newer than latest tag ($LATEST_TAG). Using pubspec version."
          fi
        fi
        
        echo "Final determined version: $FINAL_VERSION"
        echo "VERSION=$FINAL_VERSION" >> $GITHUB_OUTPUT
        echo "TAG=v$FINAL_VERSION" >> $GITHUB_OUTPUT

    # - name: Get version from pubspec.yaml
    #   id: version
    #   run: |
    #     VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r')
    #     echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
    #     echo "Version: $VERSION"

    - name: Build APK
      run: flutter build apk --release

    - name: Rename APK with custom name
      run: |
        cd build/app/outputs/flutter-apk/
        mv app-release.apk "UPT-Tutoria-v${{ steps.version.outputs.VERSION }}.apk"
        ls -la

    # - name: Rename APK with custom name
    #   run: |
    #     cd build/app/outputs/flutter-apk/
    #     mv app-release.apk "UPT-Tutoria-v${{ steps.version.outputs.VERSION }}.apk"
    #     ls -la

    - name: Create Release and Upload APK
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_VERSION: ${{ steps.version.outputs.VERSION }}
        RELEASE_TAG: ${{ steps.version.outputs.TAG }}
      run: |
        # Create release notes
        cat > release_notes.md << EOF
        ## Cambios en esta versi칩n (${RELEASE_VERSION})
        
        ### 游 Nuevas caracter칤sticas
        - Generaci칩n autom치tica de APK mediante GitHub Actions
        
        ### 游냍 Correcciones
        - Mejoras en la estabilidad general
        
        ### 游님 Instalaci칩n
        Descarga el archivo \`UPT-Tutoria-v${RELEASE_VERSION}.apk\` y inst치lalo en tu dispositivo Android.
        
        **Nota:** Es posible que necesites habilitar la instalaci칩n de aplicaciones de fuentes desconocidas en la configuraci칩n de tu dispositivo.
        EOF
        
        # Create release with GitHub CLI
        # ### MODIFICADO ###
        # Usamos las variables TAG y VERSION para crear la release
        gh release create "${RELEASE_TAG}" \
          --title "Release ${RELEASE_TAG}" \
          --notes-file release_notes.md \
          build/app/outputs/flutter-apk/UPT-Tutoria-v${RELEASE_VERSION}.apk
    
    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: UPT-Tutoria-APK
        path: build/app/outputs/flutter-apk/UPT-Tutoria-v${{ steps.version.outputs.VERSION }}.apk
